---
title: Upgrades
description: Upgrade contract, compatibility guarantees, migration rules, and platform support.
sidebar_position: 5
---

This page is the canonical upgrade contract for Agent Layer.

It defines:
- upgrade event categories,
- compatibility guarantees,
- release-versioned migration rules,
- and the supported OS/shell capability matrix.

If guidance in other docs is shorter or summarized, this page is the source of truth.

## In this page

- [How to upgrade](#how-to-upgrade)
- [Upgrade event model](#upgrade-event-model)
- [Compatibility guarantees](#compatibility-guarantees)
- [Migration rules by release](#migration-rules-by-release)
- [OS and shell capability matrix](#os-and-shell-capability-matrix)
- [Commitment level and limitations](#commitment-level-and-limitations)
- [Upgrade checklist](./upgrade-checklist)

## How to upgrade

1. Update the global `al` CLI:
   - **Homebrew (macOS/Linux):** `brew upgrade conn-castle/tap/agent-layer`
   - **Script (macOS/Linux):** `curl -fsSL https://github.com/conn-castle/agent-layer/releases/latest/download/al-install.sh | bash`
2. Upgrade the repo: `al upgrade plan` then `al upgrade`.

For a full step-by-step runbook (interactive and CI), see the [upgrade checklist](./upgrade-checklist).

## Upgrade event model

Agent Layer classifies upgrade-impact changes into three categories:

| Category | Meaning | Expected user action |
| --- | --- | --- |
| `safe auto` | Low-risk change that can be applied automatically without manual migration steps. | Usually none beyond normal verification (`al doctor`, test/lint workflow). |
| `needs review` | Change is likely safe but may interact with local customizations. | Review prompts/diffs and choose whether to apply updates. |
| `breaking/manual` | Change cannot be safely auto-migrated or may require explicit user decisions. | Follow release migration notes before proceeding. |

Qualification guidance:
- `safe auto`: formatting-only docs changes, additive defaults, or internal behavior fixes that do not require user input.
- `needs review`: template updates where local edits may conflict, workflow/instruction rewrites, generated file ownership boundary changes.
- `breaking/manual`: command/flag removals, required config schema moves, or behavior changes that require an explicit user-controlled migration step.

Breaking-change policy:
- Agent Layer uses clean breaks for breaking/manual changes. Removed commands/flags fail immediately in the target release.
- We document exact migration actions in release notes and migration guidance instead of keeping compatibility shims.

Current enforcement status:
- In Phase 10, this model is a published contract and release-labeling policy.
- Automated enforcement in CLI flows is planned for later upgrade-lifecycle phases.

## Compatibility guarantees

Agent Layer follows a sequential release-line guarantee:

- Guaranteed path: upgrade from `N-1` to `N` release lines only.
- Example: `0.7.x` to `0.8.x` is guaranteed.
- Non-guaranteed path: skipping release lines (for example `0.6.x` to `0.8.x`).

What "guaranteed" means:
- We provide documented migration guidance for the guaranteed path.
- We classify known upgrade-impact changes using the event model on this page.
- We aim to keep `al upgrade` workflows predictable for that one-step path.

What it does not mean:
- It is not a guarantee that every repo custom state can be auto-migrated.
- It does not guarantee one-step upgrades for skipped release lines.

## Migration rules by release

Migration rules are published per release and versioned with docs/release notes.

| Target release | Supported source release lines | Event summary | Required manual actions | Notes |
| --- | --- | --- | --- | --- |
| `v0.8.7` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: Adds optional agent-specific passthrough config for Claude/Codex (`agents.claude.agent_specific`, `agents.codex.agent_specific`) and opt-in repo-local Claude config isolation (`agents.claude.local_config_dir`). Sync now warns when agent-specific keys override managed keys. | No manual action required; run `al upgrade plan` then `al upgrade`. Optionally enable new behavior by setting `local_config_dir = true` and/or adding `agent_specific` keys under Claude/Codex agent sections. | No migration operations are required; defaults preserve existing behavior unless new options are explicitly configured. |
| `v0.8.6` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: Fixes upgrade snapshot validation for zero-byte files so empty unknown files no longer block `al upgrade`. Adds `al upgrade rollback --list` snapshot discovery and hardens upgrade/sanitization e2e coverage. | No manual action required; run `al upgrade plan` then `al upgrade`. | No config schema migrations are required. Snapshot behavior is backward-compatible; existing snapshot files remain valid. |
| `v0.8.5` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: `al sync` now auto-trusts the repo for Gemini CLI by writing the project root to `~/.gemini/trustedFolders.json` (Gemini-enabled projects). Config loading now strictly rejects unrecognized keys. `.env` parsing now handles quoted/escaped values more robustly. Upgrade `config_set_default` prompts no longer label choices as recommended; manifest defaults remain pre-selected. MCP tool-name collision warnings are now deterministic. | No manual action required; run `al upgrade plan` then `al upgrade`. | If Gemini trust-file writes fail, sync still completes and emits a warning with manual trust guidance. No config schema migration operations are required. |
| `v0.8.4` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: Config validation now silently strips transport-incompatible MCP fields instead of erroring. Version dispatch diagnostic no longer prints twice during version-pinned dispatch. Wizard config patching handles dotted sub-key removal. New scenario-based e2e test framework (internal). | No manual action required; run `al upgrade plan` then `al upgrade`. | No config schema changes. Configs that previously failed validation due to leftover transport-incompatible fields (e.g., `headers` on a stdio server) will now load successfully. |
| `v0.8.3` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: Bug fixes only. `al doctor` no longer produces false "missing environment variables" warnings for MCP servers that reference built-in variables like `${AL_REPO_ROOT}`. `al wizard` now removes transport-incompatible fields (e.g., `headers` on stdio servers) during config patching, fixing a circular error where the wizard completed but sync failed. | No manual action required; run `al upgrade plan` then `al upgrade`. | No config schema changes. |
| `v0.8.2` | `0.8.x`, `0.7.x` (via migration chaining) | `safe auto`: Migration manifests are now chained during multi-version upgrades. Users jumping from 0.8.0 directly to 0.8.2 will now receive the `agents.claude-vscode.enabled` config prompt that was introduced in v0.8.1. Config resilience improvements ensure `al wizard`, `al doctor`, and `al upgrade` always work even on broken configs. Removed slash command `auto-approve` frontmatter; approval permissions are controlled entirely by `approvals.mode`. Slash command frontmatter now rejects unrecognized keys. | No manual action required; run `al upgrade plan` then `al upgrade`. If any custom slash commands contain `auto-approve` or other non-`description` frontmatter keys, remove them before upgrading. | Migration chaining loads all intermediate manifests between source and target versions. When source version is unknown, only the target manifest is loaded (backward compatible). |
| `v0.8.1` | `0.8.x` | `safe auto`: Added `[agents.claude-vscode]` config section for Claude Code VS Code Extension support. Added `approvals.mode = "yolo"` for maximum agent autonomy in sandboxed environments. `al vscode` now launches when either `[agents.vscode]` or `[agents.claude-vscode]` is enabled. | No manual action required; run `al upgrade plan` then `al upgrade`. If you use `[agents.vscode]` only (without `[agents.claude-vscode]`), behavior is unchanged. If you want Claude Code VS Code Extension support, add `[agents.claude-vscode]` with `enabled = true` to `config.toml`. | `CODEX_HOME` is now cleared from the VS Code process environment when `[agents.vscode]` is disabled, preventing stale Codex config leakage. |
| `v0.8.0` | `0.7.x` | `breaking/manual`: `al init` is now one-time scaffolding and no longer supports upgrade/repair; `al init --overwrite` and `al init --force` removed. `needs review`: `al upgrade` no longer supports a single destructive `--force` mode and now requires explicit apply categories. `safe auto`: `al upgrade` now creates automatic managed-file snapshots, auto-rolls back on upgrade-step failures, and supports manual restore via `al upgrade rollback <snapshot-id>`. | Replace any automation that runs `al init --force` or `al upgrade --force` with explicit apply flags (for example `al upgrade --yes --apply-managed-updates`). Include `--apply-memory-updates` and/or `--apply-deletions` only when intentionally applying those categories. For interactive flows, run `al upgrade plan` then `al upgrade`. Use `al upgrade rollback <snapshot-id>` only when you need to restore a previously applied snapshot. | `al upgrade` never overwrites `.agent-layer/.env` or `.agent-layer/config.toml`. Root `.gitignore` managed block is still updated automatically and is excluded from upgrade plans. Snapshots are stored under `.agent-layer/state/upgrade-snapshots/`. |
| `v0.7.0` | `0.6.x` | `breaking/manual`: Windows support removed (installer, launcher, release targets, code paths). `safe auto`: upgrade path hardening (pin recovery, init dispatch bypass, download progress/errors), upgrade contract published. | **Windows users:** Windows is no longer supported; remove `al-install.ps1` and `open-vscode.bat` if present and migrate to macOS or Linux. **All other users:** No manual action required; run `al upgrade plan` and `al upgrade`. | First release with published upgrade contract. |

Migration execution rules for supported release-line upgrades:
- Each supported target release ships an embedded migration manifest at `internal/templates/migrations/<target>.json`, including `min_prior_version`.
- `al upgrade` executes migration operations before template writes and emits a deterministic migration report.
- If source version resolution fails, source-agnostic operations still run; source-gated operations are skipped and reported.
- `.agent-layer/.env` is namespace-scoped: only keys prefixed with `AL_` are loaded. Non-`AL_` keys are ignored and there is no env-key migration path.

How this table is maintained:
- Add or update a row for every release.
- If a release includes `breaking/manual` items, list exact required actions.
- If no special migration is needed, keep the row explicit to avoid ambiguity.

### Ownership baseline and manifest policy

Upgrade ownership classification is deterministic and offline:

- Release manifests are committed in-repo under `internal/templates/manifests/<version>.json`.
- Backfill manifests are committed for `v0.6.0`, `v0.6.1`, and `v0.7.0`.
- New releases must add a manifest for the new tag as part of release prep.
- Runtime upgrade planning does not call GitHub/tag APIs to infer ownership.

Repo-local baseline state is stored at:

- `.agent-layer/state/managed-baseline.json`

`al upgrade plan` compares local files against baseline evidence plus embedded manifests and emits `unknown_no_baseline` when ownership cannot be proven safely.

## OS and shell capability matrix

Windows is not supported.

| Surface | macOS | Linux | Notes |
| --- | --- | --- | --- |
| Install via Homebrew | Supported | Supported | Requires Homebrew setup for platform. |
| Install via `al-install.sh` | Supported | Supported | Requires `curl` and `sha256sum` or `shasum`. |
| `al` CLI core commands | Supported | Supported | Includes `init`, `upgrade`, `sync`, `doctor`, client launch commands. |
| VS Code launchers | Supported | Supported | macOS: `.app`/`.command`; Linux: `.desktop`/`.sh`. |
| Shell completion: `bash` | Supported | Supported | `al completion bash --install`. |
| Shell completion: `zsh` | Supported | Supported | `al completion zsh --install`; may require `fpath` setup. |
| Shell completion: `fish` | Supported | Supported | `al completion fish --install`. |

## Commitment level and limitations

This contract is intended to be explicit without over-promising:

- We commit to best-effort adherence to this model and guarantee scope.
- If we cannot fully meet a guarantee in a specific release, we will document the limitation clearly in release notes and migration guidance.
- When in doubt, prefer explicit communication over silent assumptions.
